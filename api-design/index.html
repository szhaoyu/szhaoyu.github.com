
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Google首席软件工程师Joshua Bloch谈如何设计一款优秀的API &#8212; 面湖者  documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="../about/" />
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
  
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  
  <link rel="alternate" type="application/atom+xml"  href="../blog/atom.xml" title="面湖者 Blog">
  
  
  <link href="True" rel="stylesheet">
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.postlist a {font-style: italic;}
    ul.postlist-style-disc {list-style-type: disc;}
    ul.postlist-style-none {list-style-type: none;}
    ul.postlist-style-circle {list-style-type: circle;}
  </style>

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="googlejoshua-blochapi">
<h1>Google首席软件工程师Joshua Bloch谈如何设计一款优秀的API<a class="headerlink" href="#googlejoshua-blochapi" title="Permalink to this headline">¶</a></h1>
<dl class="docutils">
<dt><strong>摘要</strong>：</dt>
<dd>API设计看似简单，其实里面的学问还不少，在整个设计流程中，一不小心就会陷入各种陷阱之中，给你带来后患无穷的危害。Joshua Bloch是Google的首席Java架构师，他在一篇PPT里向大家讲述了如何设计一款优秀的API。</dd>
</dl>
<p>Joshua Bloch是美国著名程序式设计师。他为Java平台设计并实现了许多的功能，是Google的首席Java架构师（Chief Java Architect）。他也是《Effective Java Programming Language Guide》一书的作者，就是人们常说的Effective Java。本文翻译自Joshua Bloch所发表的一个PPT： How to Design a Good API and Why it Matters。<a class="reference download internal" href="../_downloads/api-design.pdf" download=""><code class="xref download docutils literal notranslate"><span class="pre">下载</span></code></a></p>
<p>随着大数据、公共平台等互联网技术的日益成熟，API接口的重要性日益凸显，从公司的角度来看，API可以算作是公司一笔巨大的资产，公共API可以捕获用户、为公司做出许多贡献。对于个人来说，只要你编程，你就是一个API设计者，因为好的代码即是模块——每个模块便是一个API，而好的模块会被多次使用。此外，编写API还有利于开发者提高代码质量，提高自身的编码水平。</p>
<div class="section" id="api">
<h2>1. 优秀API所具备的特征<a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li>简单易学；</li>
<li>易于使用，即使没有文档；</li>
<li>很难误用；</li>
<li>易于阅读，代码易于维护；</li>
<li>足够强大，可以满足需求；</li>
<li>易于扩展；</li>
<li>适合用户。</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="id1">
<h2>2. API设计流程中的注意事项<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li>征集需求 在开始之前，你可能会收到一些解决方案，它们不一定会比现有的方案好，而你的任务是以用例的形式提取真实需求，并制定真正合适的解决方案，这样构建出来的东西就会更加有价值。</li>
<li><dl class="first docutils">
<dt>从简短的说明开始 这时，编写简短的说明最为合适，编写时需要考虑的因素有：</dt>
<dd><ul class="first last">
<li>灵活性要远胜于完整性；</li>
<li>跳出规则：听取意见并严阵以待；</li>
<li>精炼短小才易修改；</li>
<li>获得信任之后将其具体化，在此之中，编程很重要。</li>
<li>尽早编写API</li>
<li>对每一个实现进行保存，以防丢失；</li>
<li>在开始之前，列出一些合理的规定，保存所写说明，以防丢失；</li>
<li>继续编写和充实API。</li>
</ul>
</dd>
</dl>
</li>
<li>编写SPI尤为重要 Service Provider Interface即服务提供商接口，插件服务支持多种实现，例如Java Cryptography Extension (JCE)；</li>
<li>发布之前编写多个插件；</li>
<li>“三次原则”（“The Rule of Threes”）：指的是当某个功能第三次出现时，才进行”抽象化”。</li>
<li>维护切实可行的期望</li>
<li>大多数API设计都过于约束；</li>
<li>对可能会犯的错误进行预计，要用发展的思维来编写API。</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="id2">
<h2>3. API设计原则<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li>每个API接口应该只专注一件事，并做好：如果它很难命名，那么这或许是个不好的征兆，好的名称可以驱动开发、并且只需拆分与合并模块即可</li>
<li>API应尽可能地轻小：满足需求、对有疑问的地方可以暂时不使用（函数、类、方法、参数等，你可以不添加，但千万不要删除）、概念性的东西比体积重要、寻找一个良好的动力体积比；</li>
<li>实现不要影响API：关注实现细节（不要迷惑用户、不要随便改变实现方式）、意识到具体的实现细节（不要有越权的方法行为，例如不要制订哈希函数、所有的调优参数都是可疑的）；</li>
<li>不要让实现细节“泄露”到API（例如on-disk和on-the-wire格式等异常情况）；</li>
<li>最小化可访问：设计人员应尽量把类及成员设为私有，公共类不应该有公共字段（包括异常实例），最大限度地提高信息隐藏，允许模块可以被使用、理解、构建、测试和独立调试；</li>
<li>命名问题：应该见名知意，避免含糊的缩写、对同一样东西的命名应该有个一致性的前缀（遍及整个平台API）、讲究对称、代码应该易读。如下所示：</li>
</ul>
<ul class="simple">
<li>重视文档 开发API时要意识到文档的重要性。组件重用不是纸上谈兵的东西，既需要好的设计，也需要优秀的文档，这二者缺一不可，即使我们看到了良好的设计而未见文档，那么组件重用也是不妥的。</li>
</ul>
<dl class="docutils">
<dt>——摘自 D. L. Parnas 在1994年第16届国际软件开发大会上的演讲内容</dt>
<dd><code class="docutils literal notranslate"><span class="pre">文档应包含每个类、接口、方法、构造函数、参数和异常，此外，还要小心对待文档的状态空间。</span></code></dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="id3">
<h2>4. API设计决策对性能的影响<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li>API设计决策对性能的影响是真实永久的；</li>
<li>不好的决策会限制性能（类型易变、构造函数替代静态工厂、实现类型替代接口）；</li>
<li>不得打包API来提升性能（潜在的性能问题可能会得到修复，但救的了一时，救不了一世）；</li>
<li>良好的设计通常与好的性能是一致的。</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="id4">
<h2>5. API与平台和平共处<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li>养成良好的习惯：遵守标准的命名约定、避免陈旧的参数和返回类型、核心API和语言的模仿模式；</li>
<li>利用API的友好功能：泛型、可变参数、枚举、默认参数；</li>
<li>了解和避免API陷阱和缺陷：Finalizers、公共静态Final数组。</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="id5">
<h2>6. API中类的设计<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li>最小化可变性</li>
<li>最好不要随便改变类，除非有一个非常合理的理由；</li>
<li>如果是可变类，最好保持很小的状态空间、定义良好的结构，因时制宜地去调用方法。</li>
<li>子类只存在有意义的地方</li>
<li>子类具备可替代性（Liskov）；</li>
<li>公共类不应该继承其它公共类。</li>
<li>用于继承的设计和文档或者直接禁止继承（Design and Document for Inheritance or Else Prohibit it）</li>
<li>继承破坏封装</li>
<li>如果你允许子类和文档自用，那么要考虑彼此该如何互相调用方法</li>
<li>保守策略：把所有类都设置成Final</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="id6">
<h2>7. API中的方法设计<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li>模块能做到的，客户端就不要做</li>
<li>减少模板代码的使用：</li>
</ul>
<p>import org.w3c.dom.*;</p>
<p>import java.io.*;</p>
<p>import javax.xml.transform.*;</p>
<p>import javax.xml.transform.dom.*;</p>
<p>import javax.xml.transform.stream.*;</p>
<dl class="docutils">
<dt>private static final void writeDoc(Document doc, OutputStream out)throws IOException {</dt>
<dd><dl class="first docutils">
<dt>try {</dt>
<dd>Transformer t = TransformerFactory.newInstance().newTransformer();
t.setOutputProperty(OutputKeys.DOCTYPE_SYSTEM, doc.getDoctype().getSystemId());
t.transform(new DOMSource(doc), new StreamResult(out));</dd>
<dt>} catch(TransformerException e) {</dt>
<dd>throw new AssertionError(e);</dd>
</dl>
<p class="last">}</p>
</dd>
</dl>
<p>}</p>
<ul class="simple">
<li>遵守最小惊讶原则 用户API只需根据需求来设计即可，不必让客户感到惊讶，小心弄巧成拙：</li>
</ul>
<p>public class Thread implements Runnable {</p>
<blockquote>
<div>public static boolean interrupted();</div></blockquote>
<p>}
* 故障快速报告应尽快生成
* 编译时最好是静态类型、泛型；
* 方法里应该包含错误自动提交机制。</p>
<dl class="docutils">
<dt>public class Properties extends Hashtable {</dt>
<dd>public Object put(Object key, Object value);
public void save(OutputStream out, String comments);</dd>
</dl>
<p>}</p>
<ul class="simple">
<li>以String形式对所有可用数据提供编程式访问</li>
</ul>
<dl class="docutils">
<dt>public class Throwable {</dt>
<dd>public void printStackTrace(PrintStream s);
public StackTraceElement[] getStackTrace();</dd>
</dl>
<p>}
public final class StackTraceElement {</p>
<blockquote>
<div>public String getFileName();
public int getLineNumber();
public String getClassName();
public String getMethodName();
public boolean isNativeMethod();</div></blockquote>
<p>}</p>
<ul class="simple">
<li>方法重载要细心</li>
<li>避免模棱两可的重载，例如多个重载适用于同一个实物</li>
<li>即使你能分清，也最好不要这样做，最好起个不同的名字</li>
<li>如果非要定义这种重载，相同的参数确保相同的行为</li>
</ul>
<p>public TreeSet(Collection c);
public TreeSet(SortedSet s);</p>
<ul class="simple">
<li>使用合适的参数和返回类型</li>
<li>通过类来支持接口类型输入</li>
<li>尽可能地使用最特定的输入参数类型</li>
<li>如果已经有一个更好的类型存在，就不要使用string类型</li>
<li>不要用浮点型来修饰货币值</li>
<li>使用Double(64位)而不要使用Float(32位)</li>
<li>在方法上参数顺序要一致，尤其是参数类型相同时，则尤为重要</li>
</ul>
<p>#include &lt;string.h&gt;
char <a href="#id7"><span class="problematic" id="id8">*</span></a>strcpy (char <a href="#id9"><span class="problematic" id="id10">*</span></a>dest, char <a href="#id11"><span class="problematic" id="id12">*</span></a>src);
void bcopy (void <a href="#id13"><span class="problematic" id="id14">*</span></a>src, void <a href="#id15"><span class="problematic" id="id16">*</span></a>dst, int n);
java.util.Collections – first parameter always collection to be modified or queried
java.util.concurrent – time always specified as long delay, TimeUnit unit</p>
<ul class="simple">
<li>避免使用长参数列表</li>
<li>三个或三个以内的参数是最完美的</li>
<li>长参数列表是有害的，程序员容易出错，并且程序在编译、运行时会表现不好</li>
<li>缩短参数的两种方法：Break up method、创建参数助手类</li>
<li>最好避免这种情况出现：</li>
</ul>
<p>HWND CreateWindow(LPCTSTR lpClassName, LPCTSTR lpWindowName, DWORD dwStyle, int x, int y, int nWidth, int nHeight, HWND hWndParent, HMENU hMenu, HINSTANCE hInstance, LPVOID lpParam);</p>
<ul class="simple">
<li>返回值勿需进行异常处理</li>
<li>比如，返回零长度字符串或者空集合</li>
</ul>
<p>package java.awt.image;
public interface BufferedImageOp {</p>
<blockquote>
<div>public RenderingHints getRenderingHints();</div></blockquote>
<p>}</p>
</div></blockquote>
</div>
<div class="section" id="id17">
<h2>8. API中的异常设计<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li>抛出异常来说明异常状况；不要强迫客户端使用异常来控制流。</li>
</ul>
<p>private byte[] a = new byte[BUF_SIZE];
void processBuffer (ByteBuffer buf) {</p>
<blockquote>
<div><dl class="docutils">
<dt>try {</dt>
<dd><dl class="first docutils">
<dt>while (true) {</dt>
<dd>buf.get(a);
processBytes(tmp, BUF_SIZE);</dd>
</dl>
<p class="last">}</p>
</dd>
<dt>} catch (BufferUnderflowException e) {</dt>
<dd>int remaining = buf.remaining();
buf.get(a, 0, remaining);
processBytes(bufArray, remaining);</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}
ThreadGroup.enumerate(Thread[] list)</p>
<ul class="simple">
<li>支持Unchecked Exceptions</li>
<li>Checked——客户端肯定会做一些恢复措施</li>
<li>Unchecked——编程错误</li>
<li>过度使用Checked异常会产生一些模板代码</li>
</ul>
<dl class="docutils">
<dt>try {</dt>
<dd>Foo f = (Foo) super.clone();</dd>
<dt>} catch (CloneNotSupportedException e) {</dt>
<dd>throw new AssertionError();</dd>
</dl>
<p>}</p>
<ul class="simple">
<li>异常中应该包含捕获错误的（Failure-Capture）信息</li>
<li>允许诊断和修复或恢复</li>
<li>对于Unchecked异常，有异常消息就行了</li>
<li>对于Checked异常，提供访问器</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="id18">
<h2>9. 重构API设计<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ol class="arabic simple">
<li>在Vector中进行Sublist操作</li>
</ol>
<dl class="docutils">
<dt>public class Vector {</dt>
<dd>public int indexOf(Object elem, int index);
public int lastIndexOf(Object elem, int index);</dd>
</dl>
<p>}</p>
<p><strong>分析</strong>：
* 在搜索上不强大
* 没有文档很难使用
* 重构Sublist操作</p>
<dl class="docutils">
<dt>public interface List {</dt>
<dd>List subList(int fromIndex, int toIndex);</dd>
</dl>
<p>}</p>
<p><strong>分析：</strong>
* 非常强大——支持所有操作
* 使用接口来减少概念权重：较高的动力重量（power-to-weight）比
* 没有文档也易于使用</p>
<ol class="arabic simple">
<li>线程局部变量</li>
</ol>
<dl class="docutils">
<dt>public class ThreadLocal {</dt>
<dd>private ThreadLocal() { }
public static void set(String key, Object value);
public static Object get(String key);</dd>
</dl>
<p>}</p>
<ol class="arabic simple">
<li>线程局部变量重构1</li>
</ol>
<dl class="docutils">
<dt>public class ThreadLocal {</dt>
<dd>private ThreadLocal() { }
public static class Key { Key() { } }
public static Key getKey() { return new Key(); }
public static void set(Key key, Object value);
public static Object get(Key key);</dd>
</dl>
<p>}</p>
<p>可以运行，但是需要使用模板代码。</p>
<p>static ThreadLocal.Key serialNumberKey = ThreadLocal.getKey();
ThreadLocal.set(serialNumberKey, nextSerialNumber());
System.out.println(ThreadLocal.get(serialNumberKey));</p>
<ol class="arabic simple">
<li>线程局部变量重构2</li>
</ol>
<dl class="docutils">
<dt>public class ThreadLocal {</dt>
<dd>public ThreadLocal() { }
public void set(Object value);
public Object get();</dd>
</dl>
<p>}</p>
<p>从API和客户端代码中删除了无用代码。</p>
<p>static ThreadLocal serialNumber = new ThreadLocal();
serialNumber.set(nextSerialNumber());
System.out.println(serialNumber.get());</p>
</div></blockquote>
</div>
</div>
<div class="section" id="id19">
<h1>总结<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div>API设计是一件非常高端大气上档次的工艺，对程序员、终端用户和公司都会有所提升。不要盲目地去遵守文中所提及的规则、说明等，但也不要去侵犯他们，API设计不是件简单的工艺，也不是一种可以孤立行动的活。当然完美永远无法实现，但我们要努力去追求完美。</div></blockquote>
</div>

  <div class="section">
  
    


<div class="section">
  <span style="float: left;">
  
  </span>
  <span>&nbsp;</span>
  <span style="float: right;">
  
  
  <a href="../bi-tools/">
    BI: 数据清洗、分析与报表工具
    <i class="fa fa-arrow-circle-right"></i>
  </a>
  </span>
  
</div>

  
  
  </div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../">面湖者</a></h1>









  
  
  <h2>
  
  <i class="fa fa-calendar"></i>
    16 February 2015
  
  </h2>

  <ul>
    

  
  <li id="author"><span><i class="fa-fw fa fa-user"></i></span>
    
      
      <a href="../blog/author/zhaoyu/">Zhaoyu</a>
      
    </li>
  

  

  

  

  
  <li id="tags"><span><i class="fa-fw fa fa-tag"></i></span>
    
      
      <a href="../blog/tag/api/">api</a>
      
    </li>
  
  
  </ul>


<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../about/">About Zhaoyu</a></li>
</ul>


  <h3><a href="../blog/">Recent Posts</a></h3>
  <ul>
    
    
      <li><a href="../hadoop-post/">19 December - review hadoop architecture & usage</a></li>
    
      <li><a href="../mr-sql-post/">19 December - MR vs SQL</a></li>
    
      <li><a href="../docker-network-post/">19 December - Connection between dockers accross different hosts</a></li>
    
      <li><a href="../js-post/">16 December - review javascript</a></li>
    
      <li><a href="../bi-tools/">01 May - BI: 数据清洗、分析与报表工具</a></li>
    
  </ul>

  <h3><a href="../blog/tag/">Tags</a></h3>
  <style type="text/css">
    ul.ablog-cloud {list-style: none; overflow: auto;}
    ul.ablog-cloud li {float: left; height: 20pt; line-height: 18pt; margin-right: 5px;}
    ul.ablog-cloud a {text-decoration: none; vertical-align: middle;}
    li.ablog-cloud-1{font-size: 80%;}
    li.ablog-cloud-2{font-size: 95%;}
    li.ablog-cloud-3{font-size: 110%;}
    li.ablog-cloud-4{font-size: 125%;}
    li.ablog-cloud-5{font-size: 140%;}
  </style>
  <ul class="ablog-cloud">
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../blog/tag/sql/">SQL</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../blog/tag/api/">api</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../blog/tag/bi/">bi</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../blog/tag/docker/">docker</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-5">
        <a href="../blog/tag/hadoop/">hadoop</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../blog/tag/javascript/">javascript</a></li>
      
    
  </ul>

  <h3><a href="../blog/category/">Categories</a></h3>
  <ul>
  
    
    <li><a href="../blog/category/docker/">docker (1)</a></li>
    
  
  </ul>

  <h3><a href="../blog/archive/">Archives</a></h3>
  <ul>
  
    
    <li><a href="../blog/2018/">2018 (4)</a></li>
    
  
    
    <li><a href="../blog/2015/">2015 (2)</a></li>
    
  
  </ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Zhaoyu.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../_sources/api-design.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>